<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Stanforis — Map</title>
  <link href="../../css/output.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>html,body,#map{height:100%;} .leaflet-container{height:480px;border-radius:12px}</style>
</head>
<body class="bg-neutral-950 text-neutral-100">
  <div class="mx-auto max-w-md min-h-screen p-4">
    <header class="mb-3">
      <div class="flex items-center gap-3"><button onclick="openPage('dashboard.html')" class="p-2 rounded-xl bg-neutral-800">←</button><h1 class="font-medium">Map — Dwellings</h1></div>
    </header>

    <main>
      <div id="map" class="rounded-2xl overflow-hidden"></div>
      <div class="mt-3 text-xs text-neutral-400">Click a marker to assign to Umudugudu or open dwelling.</div>
    </main>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // Initialize map
    const map = L.map('map').setView([-1.9444, 30.0619], 12); // Rwanda approximate center
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OSM contributors'
    }).addTo(map);

    // Firebase configuration & initialization
    const firebaseConfig = {
      apiKey: "FIREBASE_API_KEY",
      authDomain: "PROJECT.firebaseapp.com",
      databaseURL: "https://PROJECT-default-rtdb.firebaseio.com",
      projectId: "PROJECT",
      storageBucket: "PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();
    const dwellRef = db.ref('dwellings');

    // Require login
    // auth.onAuthStateChanged(u => {
    //   if (!u) location.href = 'login.html';
    //   else loadMarkers();
    // });

    let markers = {};

    function loadMarkers() {
      dwellRef.on('value', snap => {
        const data = snap.val() || {};

        // Remove old markers
        Object.values(markers).forEach(m => map.removeLayer(m));
        markers = {};

        // Add markers for dwellings with coordinates
        Object.entries(data).forEach(([id, d]) => {
          if (d.lat && d.lng) {
            const m = L.marker([d.lat, d.lng]).addTo(map);
            m.bindPopup(`
              <div style="min-width:160px">
                <strong>${escapeHtml(d.address || id)}</strong>
                <div class="text-xs">${(d.members || []).length} member(s)</div>
                <div style="margin-top:6px">
                  <button onclick="openDwelling('${id}')" class="p-1 rounded bg-neutral-800 text-xs">Open</button>
                  <button onclick="assignUmudugudu('${id}')" class="p-1 rounded bg-neutral-800 text-xs">Assign Umudugudu</button>
                </div>
              </div>
            `);
            markers[id] = m;
          }
        });
      });
    }

    function openDwelling(id) {
      // Redirect to dwelling list/detail page (you can pass id if you implement details)
      window.location.href = 'dwellings.html';
    }

    function assignUmudugudu(id) {
      const u = prompt('Umudugudu id to assign');
      if (!u) return;
      db.ref('dwellings/' + id).update({ umudugudu: u });
      alert('Assigned');
    }

    function escapeHtml(s) {
      return (s || '').replace(/[&<>"']/g, m => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[m]));
    }

    function openPage(p) {
      location.href = p;
    }
  </script>

</body>
</html>
